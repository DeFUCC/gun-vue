<!-- This is a static file -->
<!-- served from your routes in server.js -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="A cool thing made with Glitch" />

    <title>No store GUN peer</title>
  
    <link rel="stylesheet" href="/style.css" />
    <script defer type="module">
      import "https://cdn.jsdelivr.net/npm/gun/gun.js";
      import { createApp, reactive } from "https://unpkg.com/petite-vue?module";

      const gun = GUN(["https://etogun.glitch.me/gun"]);
      const gameName = "gunvue";
      const game = gun.get(gameName);
      const relay = gun.get("etogun.glitch.me");

      const Store = reactive({
        relay: {
          pulse: "connecting"
        },
        players: {},
        listen() {
          self = this;
          relay.get("pulse").on(d => (self.relay.pulse = d));

          game
            .get("players")
            .map()
            .on((d, k) => {
              if (d == null) return;
              self.players[k] = self.players[k] || {};
              self.players[k] = { ...d };
            });
        }
      });

      function Player(props) {
        const blob = reactive({
          $template: "#player-template",
          pub: props?.pub,
          x: 0,
          y: 0,
          pulse: 0
        });

        game
          .get("players")
          .get(blob.pub)
          .on((d, k) => {
          if(!d) return
            Object.assign(blob,{...d})
          });

        return blob;
      }

      Store.listen();

      createApp({ Store, Player }).mount();
    </script>

    <template id="player-template">
      {{ pub }} {{pulse}} {{x}} {{y}}
    </template>
  </head>
  <body v-scope>
    <header>
      <h5>{{Store.relay.pulse}}</h5>
    </header>
    <main>
      <div id="app">
        {{test}}
      </div>
      
      <ul>
        <li
          v-for="(p,k) in Store.players"
          :key="p"
          v-scope="Player({pub:k})"
        ></li>
      </ul>
    </main>
  </body>
</html>
