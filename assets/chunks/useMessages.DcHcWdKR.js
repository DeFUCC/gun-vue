import{j as w,a as l,S as f}from"./components.D0YhEJeR.js";import{p as h,ax as v,ah as y,h as b}from"./framework.BN2VI_cg.js";function M(e){const o=w(),{user:c}=l(),a=h(""),s=h({}),m=v(async()=>Object.entries(s.value||{}).sort(([,t],[,u])=>((t==null?void 0:t.timestamp)||0)-((u==null?void 0:u.timestamp)||0)).map(([,t])=>t),[],{debounce:200});o.user(e).get("epub").once(t=>a.value=t),o.user(e).get("messages").get(c.pub).map().once(function(t,u){this.map().on(async(r,g)=>s.value[g]=await n(r,u,e))}),o.user().get("messages").get(e).map().once(function(t,u){this.map().on(async(r,g)=>s.value[g]=await n(r,u,c.pub))});async function n(t,u,r){if(typeof t!="number"&&t&&t.startsWith("SEA")){const g=await c.secret(a.value),d=await f.work(g,void 0,void 0,{salt:u}),p=await f.decrypt(t,d);return!p||typeof p!="object"?void 0:{timestamp:p.timestamp,author:r,text:p.text}}}return y({epub:a,messages:s,sorted:m,send:A})}function j(e){const o=w(),{user:c}=l(),a=y({}),s=h(!1);return o.user(e).get("epub").on(n=>s.value=n),o.user(e).get("messages").get(c.pub).map().map().on((n,i)=>{n&&!n.startsWith("SEA")||(a[i]=n)}),o.user().get("messages").get(e).map().map().on((n,i)=>{n&&!n.startsWith("SEA")||(a[i]=n)}),{count:b(()=>Object.keys(a).length),available:s}}async function A(e,o){if(!e||!o)return;const c=w(),{user:a}=l(),s=new Date,m=await c.user(e).get("epub").then(),n=s.toLocaleDateString("en-CA"),i=s.getTime(),t=await a.secret(m),u=await f.work(t,void 0,void 0,{salt:n}),r=await f.encrypt({timestamp:i,text:o},u);c.user().get("messages").get(e).get(n).set(r)}function k(){const e=w(),{user:o}=l(),c=y({});return o.is&&(e.user().get("messages").map().on((a,s)=>{c[s]=a}),e.user().get("mates").map().on(async(a,s)=>{await e.user(s).get("epub").then()&&(c[s]=a)})),c}export{j as a,k as b,M as u};
