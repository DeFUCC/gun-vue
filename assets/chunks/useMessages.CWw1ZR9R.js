import{j as f,a as l,S as p}from"./components.CvmKEy0x.js";import{p as y,ax as w,ah as h,h as d}from"./framework.Cf-rbDpz.js";function S(e){const a=f(),{user:o}=l(),u=y(""),t=y({}),m=w(async()=>Object.entries(t.value||{}).sort(([,n],[,r])=>((n==null?void 0:n.timestamp)||0)-((r==null?void 0:r.timestamp)||0)).map(([,n])=>n),[],{debounce:200});a.user(e).get("epub").once(n=>u.value=n),a.user(e).get("messages").get(o.pub).map().once(function(n,r){this.map().on(async(g,c)=>t.value[c]=await s(g,r,e))}),a.user().get("messages").get(e).map().once(function(n,r){this.map().on(async(g,c)=>t.value[c]=await s(g,r,o.pub))});async function s(n,r,g){if(typeof n!="number"&&n&&n.startsWith("SEA")){const c=await p.decrypt(n,await p.work(await o.secret(u.value),void 0,void 0,{salt:r}));return!c||typeof c!="object"?void 0:{timestamp:c.timestamp,author:g,text:c.text}}}return h({epub:u,messages:t,sorted:m,send:v})}function x(e){const a=f(),{user:o}=l(),u=h({}),t=y(!1);return a.user(e).get("epub").on(s=>t.value=s),a.user(e).get("messages").get(o.pub).map().map().on((s,i)=>{s&&!s.startsWith("SEA")||(u[i]=s)}),a.user().get("messages").get(e).map().map().on((s,i)=>{s&&!s.startsWith("SEA")||(u[i]=s)}),{count:d(()=>Object.keys(u).length),available:t}}async function v(e,a){if(!e||typeof a!="string"||a.trim()==="")return;const o=f(),{user:u}=l(),t=new Date,m=await o.user(e).get("epub").then(),s=t.toLocaleDateString("en-CA"),i=await p.encrypt({timestamp:t.getTime(),text:a},await p.work(await u.secret(m),void 0,void 0,{salt:s}));o.user().get("messages").get(e).get(s).set(i)}function M(){const e=f(),{user:a}=l(),o=h({});return a.is&&(e.user().get("messages").map().on((u,t)=>{o[t]=u}),e.user().get("mates").map().on(async(u,t)=>{await e.user(t).get("epub").then()&&(o[t]=u)})),o}export{x as a,M as b,S as u};
