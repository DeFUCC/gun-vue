import{j as h,a as d,S as g}from"./components.DEDLcqDQ.js";import{ah as w,aA as y,p as S,h as A}from"./framework.DtSfhgxr.js";function v(s){const o=h(),{user:c}=d(),t=w({epub:"",messages:{},sorted:[],async send(n){if(!n)return;const e=new Date,a={timestamp:e.getTime(),text:n},i=e.toLocaleDateString("en-CA"),u=await c.secret(t.epub),p=await g.work(u,void 0,void 0,{salt:i}),f=await g.encrypt(a,p);o.user().get("chat").get(s).get(i).set(f)}});o.user(s).get("epub").once(n=>t.epub=n),o.user(s).get("chat").get(c.pub).map().once(function(n,e){r(n,e,s,this)}),o.user().get("chat").get(s).map().once(function(n,e){r(n,e,c.pub,this)});function r(n,e,a,i){i.map().on(async(u,p)=>{if(typeof u!="number"&&u&&u.startsWith("SEA")){const f=await c.secret(t.epub),b=await g.work(f,void 0,void 0,{salt:e}),m=await g.decrypt(u,b);if(!m||typeof m!="object")return;const l={timestamp:m.timestamp,author:a,text:m.text};t.messages[p]=l}})}return y(()=>t.messages,n=>{t.sorted=Object.values(t.messages||{}).sort((e,a)=>(e==null?void 0:e.timestamp)>(a==null?void 0:a.timestamp)?1:-1)},{debounce:200,immediate:!0,deep:!0}),t}function x(s){const o=h(),{user:c}=d(),t=w({}),r=S(!1);return o.user(s).get("epub").on(e=>r.value=e),o.user(s).get("chat").get(c.pub).map().map().on((e,a)=>{e&&!e.startsWith("SEA")||(t[a]=e)}),o.user().get("chat").get(s).map().map().on((e,a)=>{e&&!e.startsWith("SEA")||(t[a]=e)}),{count:A(()=>Object.keys(t).length),available:r}}function D(){const s=h(),{user:o}=d(),c=w({});return o.is&&(s.user().get("chat").map().on((t,r)=>{c[r]=t}),s.user().get("mates").map().on(async(t,r)=>{await s.user(r).get("epub").then()&&(c[r]=t)})),c}export{x as a,D as b,v as u};
