import{ah as f,p as b,V as k}from"./framework.BfubPTv1.js";function O(){const i=f(new Map),s=b(!1),u=f({done:!1,progress:0,downloadSpeed:0,downloaded:0});let n=null,o=null;function F(e){return e.replace(/[^a-zA-Z0-9.-]/g,"_")}async function g(e){try{const a=await(await(await n.getFileHandle(`${e}.meta.json`)).getFile()).text();return JSON.parse(a)}catch{return null}}async function m(e,t){const a=await(await n.getFileHandle(`${e}.meta.json`,{create:!0})).createWritable();await a.write(JSON.stringify(t)),await a.close()}async function d(){try{n=await navigator.storage.getDirectory();const e=(await k(async()=>{const{default:t}=await import("./webtorrent.min.D4AedfBj.js");return{default:t}},[])).default;o=new e,s.value=!0,await p()}catch(e){return console.error("Torrent system initialization failed:",e),!1}}async function p(){if(n)for await(const[e]of n.entries()){if(e.endsWith(".meta.json"))continue;const t=await g(e);if(!t)continue;const r=await A(e);if(r){const a=new File([r],t.originalName,{type:t.type});await w(a,e),console.log("Loaded file:",t.originalName)}}}async function w(e,t){return new Promise(r=>{o.seed([e],a=>{i.set(t,{file:e,torrent:a,info:{infoHash:a.infoHash,magnetURI:a.magnetURI,name:a.name,length:a.length}}),r(i.get(t))})})}async function y(e){s.value||await d();const t=[];for(const r of e){const a=await v(r);if(a){const l=await w(r,a);t.push(l)}}return t}async function h(e){const t=i.get(e);t!=null&&t.torrent&&t.torrent.destroy(),await(n==null?void 0:n.removeEntry(e)),await(n==null?void 0:n.removeEntry(`${e}.meta.json`).catch(()=>{})),i.delete(e)}async function v(e){if(!n)return null;try{const t=F(Date.now()+"_"+e.name),a=await(await n.getFileHandle(t,{create:!0})).createWritable();return await a.write(e),await a.close(),await m(t,{originalName:e.name,type:e.type,lastModified:e.lastModified}),t}catch(t){return console.error("Error saving to OPFS:",t),null}}async function A(e){if(!n)return null;try{return await(await n.getFileHandle(e)).getFile()}catch(t){return console.error("Error loading from OPFS:",t),null}}async function H(e){s.value||await d();const t=`magnet:?xt=urn:btih:${e}&tr=udp%3A%2F%2Ftracker.leechers-paradise.org%3A6969&tr=udp%3A%2F%2Ftracker.coppersurfer.tk%3A6969&tr=udp%3A%2F%2Ftracker.opentrackr.org%3A1337&tr=udp%3A%2F%2Fexplodie.org%3A6969&tr=udp%3A%2F%2Ftracker.empire-js.us%3A1337&tr=wss%3A%2F%2Ftracker.btorrent.xyz&tr=wss%3A%2F%2Ftracker.openwebtorrent.com`;return new Promise(async r=>{function a(_){const S=_.files;o.on("download",c=>{Object.assign(u,{done:c.done,progress:c.progress,downloaded:c.downloaded,downloadSpeed:c.downloadSpeed})}),r(S)}let l=await o.get(e);l?a(l):o.add(t,a)})}return{files:i,initialized:s,downloadStatus:u,init:d,upload:y,download:H,deleteFile:h}}export{O as u};
