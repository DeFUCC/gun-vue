import{j as g,aI as v,a as x,as as h,i as w,r as $,aJ as T,aK as z,aL as E,aM as F,aN as O,au as P}from"./components.Cv2JVUi5.js";import{c as D}from"./useMd.6aACZvQc.js";import{r as N}from"./useGift.kvKXvGya.js";import{ak as S,p as y,h as Z}from"./framework.ap9ZVjPY.js";function k({hash:n="",loadMedia:t=!0}){const o=g(),i=S({});o.get("posts").get("#index").get(n).on(async a=>{try{Object.assign(i,JSON.parse(a))}catch{i.raw=a}t&&["icon","cover","text"].forEach(s=>{i[s]&&o.get("posts").get(`#${s}`).get(i[s]).on(c=>{i[s]=c})})});const r=y(!1);async function e(){r.value=!0,await j(i),r.value=!1}return{post:i,download:e,downloading:r}}async function A(n,t){var u;const o=g(),{user:i}=x(),{icon:r,cover:e,content:a}=t;t.icon=await d("icon",r),t.cover=await d("cover",e),t.content=await d("content",a),t=N(t);const{hashed:s,hash:c}=await h(t);console.log(c,t,n),o.get("posts").get("#index").get(`${c}`).put(s),o.user(w.pub).get("posts").get(`${n}:${c}@${i.pub}`).put(!0,null,{opt:{cert:(u=w.features)==null?void 0:u.posts}})}async function j(n){let{title:t,statement:o}=n;const{zipPost:i,addFile:r,downloadZip:e}=H();if((t||o)&&!n.raw)await i({...n});else{t="file";const a=await $(n.raw);await r({title:T(a),file:n.raw})}return await e({title:t}),!0}async function p(n,t){return n&&t&&typeof t=="string"&&t.length==44&&t.slice(0,5)!="data:"?await g().get("posts").get(`#${n}`).get(t).then():t}async function d(n,t){if(n&&t){const o=await $(t);return g().get("posts").get(`#${n}`).get(`${o}`).put(t),o}else return t}function K({hash:n}){const t=g(),o=y(0),i=Z(()=>v(Date.now()-o.value||1e3));t.get("posts").get("#index").get(n).on(function(e,a,s){o.value=s.put[">"]});async function r(){let e=await t.get("posts").get("#index").get(n).then();t.get("posts").get("#index").get(n).put(e)}return{timestamp:o,msTime:i,refresh:r}}function H(){const n=new z;async function t({title:e,file:a,folder:s="."}){F(a);const c=O(a),u=await fetch(a).then(f=>f.blob()),l=`${e}.${c}`;return n.file(`${s}/${l}`,u),l}function o({md:e,title:a}){n.file(`${a}/index.md`,D(e))}async function i(e){let{text:a,title:s,statement:c,content:u}=e;e==null||delete e.text,e==null||delete e.content,s||(s=c?c.slice(0,12):P());const l=["cover","icon"];for(let f of l){let m=await p(f,e[f]);if(m){const b=await t({title:f,file:m,folder:s});e[f]=b}}a=await p("text",a),o({title:s,md:{frontmatter:e,content:a||u}})}async function r({title:e=""}={}){let a=new Date;const s=a.getTimezoneOffset();a=new Date(a.getTime()-s*60*1e3);const c=a.toISOString().split("T")[0],u=await n.generateAsync({type:"blob",comment:`Exported from ${e} at ${location} on ${c}`,compression:"DEFLATE",compressionOptions:{level:9}}),l=`${e}-${c}.zip`;return E(u,"application/zip",l),!0}return{zip:n,zipPost:i,addMd:o,addFile:t,downloadZip:r}}export{A as a,H as b,K as c,k as u};
