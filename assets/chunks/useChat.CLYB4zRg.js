import{j as O,a as V,i as o,O as d}from"./components.-o4Ozxvo.js";import{p as z,ah as f,h as p,aW as x}from"./framework.CyF0gi9V.js";const c="chat";function P(b="general"){const r=O(),{user:u}=V(),g=z(b),a=f({[b]:{upvotes:new Set,downvotes:new Set}}),i=f({}),l=f({});r.user(o.pub).get(c).map().on((e,s)=>{const[t,n]=s.split("@");a[t]||(a[t]={upvotes:new Set,downvotes:new Set}),a[t].upvotes.delete(n),a[t].downvotes.delete(n),e===!0?(a[t].upvotes.add(n),n==u.pub&&(delete i[t],l[t]=!0)):e===!1?(a[t].downvotes.add(n),n==u.pub&&(i[t]=!0,delete l[t])):e===null&&n==u.pub&&(delete i[t],delete l[t])});const h=p(()=>Object.entries(a).map(([e,s])=>({title:e,authors:Array.from(s.upvotes),rating:s.upvotes.size-s.downvotes.size,my:s.upvotes.has(u.pub)?1:s.downvotes.has(u.pub)?-1:0})).filter(e=>e.title=="general"||l[e.title]||!i[e.title]&&e.rating>=0).sort((e,s)=>s.rating-e.rating));async function w(e){const t=await r.user(o.pub).get(c).get(`${d(e)}@${u.pub}`).then()===!0?null:!0;r.user(o.pub).get(c).get(`${d(e)}@${u.pub}`).put(t,void 0,{opt:{cert:o.features.chat}})}async function $(e){const t=await r.user(o.pub).get(c).get(`${d(e)}@${u.pub}`).then()===!1?null:!1;r.user(o.pub).get(c).get(`${d(e)}@${u.pub}`).put(t,void 0,{opt:{cert:o.features.chat}})}const m=p(()=>r.user(o.pub).get("chat/"+g.value)),v=p(()=>{const e=f({});return m.value.map().on((s,t)=>{const n=t.substring(0,13),j=t.substring(14),D={timestamp:n,author:j,text:s};e[t]=D}),e}),y=p(()=>Object.values(v.value||{})),C=x(y),L=p(()=>C.value.sort((e,s)=>e.timestamp>s.timestamp?1:-1));function S(e){if(!e)return;let s=Date.now();m.value.get(`${s}@${u.pub}`).put(e,void 0,{opt:{cert:o.features.chat}})}return{send:S,addChat:w,removeChat:$,currentChat:g,chats:h,messages:v,sorted:L}}export{P as u};
