import{j as g,aE as v,a as x,ao as h,i as w,r as $,aF as T,aG as E,aH as F,aI as z,aJ as O,aq as P}from"./components.BLyRHMpj.js";import{c as D}from"./useMd.C0LjUaFH.js";import{r as H}from"./useGift.pOSaTO5v.js";import{ai as N,p as y,h as S}from"./framework.BoVd_Pm6.js";function G({hash:n="",loadMedia:t=!0}){const o=g(),i=N({});o.get("posts").get("#index").get(n).on(async a=>{try{Object.assign(i,JSON.parse(a))}catch{i.raw=a}t&&["icon","cover","text"].forEach(s=>{i[s]&&o.get("posts").get(`#${s}`).get(i[s]).on(c=>{i[s]=c})})});const r=y(!1);async function e(){r.value=!0,await Z(i),r.value=!1}return{post:i,download:e,downloading:r}}async function M(n,t){var u;const o=g(),{user:i}=x(),{icon:r,cover:e,content:a}=t;t.icon=await d("icon",r),t.cover=await d("cover",e),t.content=await d("content",a),t=H(t);const{hashed:s,hash:c}=await h(t);console.log(c,t,n),o.get("posts").get("#index").get(`${c}`).put(s),o.user(w.pub).get("posts").get(`${n}:${c}@${i.pub}`).put(!0,null,{opt:{cert:(u=w.features)==null?void 0:u.posts}})}async function Z(n){let{title:t,statement:o}=n;const{zipPost:i,addFile:r,downloadZip:e}=j();if((t||o)&&!n.raw)await i({...n});else{t="file";const a=await $(n.raw);await r({title:T(a),file:n.raw})}return await e({title:t}),!0}async function p(n,t){return n&&t&&typeof t=="string"&&t.length==44&&t.slice(0,5)!="data:"?await g().get("posts").get(`#${n}`).get(t).then():t}async function d(n,t){if(n&&t){const o=await $(t);return g().get("posts").get(`#${n}`).get(`${o}`).put(t),o}else return t}function k({hash:n}){const t=g(),o=y(0),i=S(()=>v(Date.now()-o.value||1e3));t.get("posts").get("#index").get(n).on(function(e,a,s){o.value=s.put[">"]});async function r(){let e=await t.get("posts").get("#index").get(n).then();t.get("posts").get("#index").get(n).put(e)}return{timestamp:o,msTime:i,refresh:r}}function j(){const n=new E;async function t({title:e,file:a,folder:s="."}){z(a);const c=O(a),u=await fetch(a).then(f=>f.blob()),l=`${e}.${c}`;return n.file(`${s}/${l}`,u),l}function o({md:e,title:a}){n.file(`${a}/index.md`,D(e))}async function i(e){let{text:a,title:s,statement:c,content:u}=e;e==null||delete e.text,e==null||delete e.content,s||(s=c?c.slice(0,12):P());const l=["cover","icon"];for(let f of l){let m=await p(f,e[f]);if(m){const b=await t({title:f,file:m,folder:s});e[f]=b}}a=await p("text",a),o({title:s,md:{frontmatter:e,content:a||u}})}async function r({title:e=""}={}){let a=new Date;const s=a.getTimezoneOffset();a=new Date(a.getTime()-s*60*1e3);const c=a.toISOString().split("T")[0],u=await n.generateAsync({type:"blob",comment:`Exported from ${e} at ${location} on ${c}`,compression:"DEFLATE",compressionOptions:{level:9}}),l=`${e}-${c}.zip`;return F(u,"application/zip",l),!0}return{zip:n,zipPost:i,addMd:o,addFile:t,downloadZip:r}}export{M as a,j as b,k as c,G as u};
