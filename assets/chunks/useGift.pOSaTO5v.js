import{g as u}from"./composables.BvLrgJKt.js";import{j as b,a as j,am as v,i as p,an as G,ao as h}from"./components.BLyRHMpj.js";import{ai as m,h as a,q as N,p as $}from"./framework.BoVd_Pm6.js";function A(n){const o=b(),s=m({}),e=m({from:!1,to:!1,complete:a(()=>e.from&&e.to),status:a(()=>e.from?e.to?"complete":"proposed":"canceled")});return o.get("#"+u).get(n).once((r,c)=>{try{Object.assign(s,JSON.parse(r)),o.user(s.from).get(u).get(c).on(i=>{e.from=i}),o.user(s.to).get(u).get(c).on(i=>{e.to=i})}catch{}}),{gift:s,state:e}}async function E(n,o=!0){const{user:s}=j();s.db.get(u).get(n).put(o)}function J(n){const{user:o}=j(),{now:s,pause:e}=v({interval:1e3,controls:!0}),r=m({from:a(()=>o==null?void 0:o.pub),to:"",qn:null,ql:null,wish:"",project:"",date:a(()=>s.value.getTime()),room:a(()=>p.pub)}),c=a(()=>{let t=q(r);return t.qn=Number(t.qn),t}),i=["from","to","qn","ql"],w=a(()=>i.reduce((f,l)=>f&&r[l],!0));N(r,t=>{t.project&&(r.to=t.project.slice(-87))});const y=G(async()=>{const{hash:t}=await h(c.value);return t}),d=$(!1);Object.assign(r,n);const g=b();async function O(){var l;const{hash:t,hashed:f}=await h(c.value);console.log(t,f),g.get("#"+u).get(t).put(f),g.user().get(u).get(t).put("proposed",()=>{e(),d.value=!0}),(l=p.features)!=null&&l.gifts&&g.user(p.pub).get(u).get(`${t}@${o.pub}`).put(!0,()=>{console.log(`gift ${t} published`)},{opt:{cert:p.features.gifts}})}return{gift:r,cleanGift:c,valid:w,propose:O,proposed:d,hash:y}}function q(n){return Object.entries(n).filter(([o,s])=>!!s).reduce((o,[s,e])=>({...o,[s]:e===Object(e)?q(e):e}),{})}export{J as a,E as g,q as r,A as u};
