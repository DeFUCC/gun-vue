import{h as f,a as b,S as p,R as l}from"./components.vhzIzXJf.js";import{aj as w,s as y,h as S}from"./framework.2DHwbLKR.js";function j(s){const n=f(),{user:o}=b(),e=w({epub:"",messages:{},sorted:[],async send(a){if(!a)return;const t=new Date,c={timestamp:t.getTime(),text:a},i=t.toLocaleDateString("en-CA"),u=await o.secret(e.epub),g=await p.work(u,void 0,void 0,{salt:i}),h=await p.encrypt(c,g);n.user().get("chat").get(s).get(i).set(h)}});n.user(s).get("epub").once(a=>e.epub=a),n.user(s).get("chat").get(o.pub).map().once(function(a,t){r(a,t,s,this)}),n.user().get("chat").get(s).map().once(function(a,t){r(a,t,o.pub,this)});function r(a,t,c,i){i.map().on(async(u,g)=>{if(typeof u!="number"&&u&&u.startsWith("SEA")){const h=await o.secret(e.epub),v=await p.work(h,void 0,void 0,{salt:t}),m=await p.decrypt(u,v);if(!m||typeof m!="object")return;const d={timestamp:m.timestamp,author:c,text:m.text};e.messages[g]=d}})}return l(()=>e.messages,a=>{e.sorted=Object.values(e.messages||{}).sort((t,c)=>t.timestamp>c.timestamp?1:-1)},{debounce:200,immediate:!0,deep:!0}),e}function k(s){const n=f(),{user:o}=b(),e=w({}),r=y(!1);return n.user(s).get("epub").on(t=>r.value=t),n.user(s).get("chat").get(o.pub).map().map().on((t,c)=>{t&&!t.startsWith("SEA")||(e[c]=t)}),n.user().get("chat").get(s).map().map().on((t,c)=>{t&&!t.startsWith("SEA")||(e[c]=t)}),{count:S(()=>Object.keys(e).length),available:r}}function x(){const s=f(),{user:n}=b(),o=w({});return n.is&&(s.user().get("chat").map().on((e,r)=>{o[r]=e}),s.user().get("mates").map().on(async(e,r)=>{await s.user(r).get("epub").then()&&(o[r]=e)})),o}export{k as a,x as b,j as u};
