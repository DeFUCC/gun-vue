import{h as v,j as $,ar as P,aB as h}from"./components.lt0YP4UG.js";import{b as y,u as x,a as M}from"./useZip.BKp-VSA8.js";import{p as Z}from"./useMd.DU6UG5jk.js";import{ah as w,h as b,p as k,b2 as A}from"./framework.BtfQKcS5.js";function G(s){if(!s)return;const u=v(),n=w({}),o=w({});u.user($.pub).get("posts").map().on(function(t,e){let c=e.indexOf(s);if(c==-1)return;let r=e.slice(-87),l=e.slice(0,44),p=e.slice(45,89);c==0?(n[p]=n[p]||{},n[p][r]=t):(o[l]=o[l]||{},o[l][r]=t)});const f=b(()=>{let t=0;for(let e in n)t:for(let c in n[e])if(n[e][c]){t++;break t}return t}),d=b(()=>{let t=0;for(let e in o)t:for(let c in o[e])if(o[e][c]){t++;break t}return t}),i=k(!1);async function a(){i.value=!0,i.value=!await B(s,n)}function m(t){E(s,t)}return{posts:n,backlinks:o,countPosts:f,countBacklinks:d,downloadPosts:a,downloading:i,uploadPosts:m}}async function B(s,u){if(!u)return;const{zip:n,zipPost:o,downloadZip:f}=y(),d=A({});for(let i in u){const{post:a}=x({tag:s,hash:i});d[i]=a,a.title&&await o(a)}return await f({title:`#${s}`}),!0}function E(s,u){Array.from(u).forEach(async n=>{const o=await P.loadAsync(n);o.comment&&console.info("Zip file comment: "+o.comment),o.forEach(async(f,d)=>{var i;if(f.endsWith("index.md")){let a=f.slice(0,-9),m=await d.async("string"),{frontmatter:t,content:e}=Z(m);if(t=t||{},t.title=(t==null?void 0:t.title)||a,t.icon){const r=await o.file(`${a}/${t.icon}`).async("base64"),l=h(r);t.icon=`data:${l};base64,${r}`}if(t.cover){const r=await((i=o==null?void 0:o.file(`${a}/${t.cover}`))==null?void 0:i.async("base64")),l=h(r);t.cover=`data:${l};base64,${r}`}let c={...t,content:e};M(s,c)}})})}export{G as u};
